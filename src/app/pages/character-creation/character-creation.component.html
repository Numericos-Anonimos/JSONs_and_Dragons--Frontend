<div class="container py-5">
  <div class="loading-overlay-advanced" *ngIf="isLoadingDecision">
    <div class="loading-content-advanced">
      <div class="dice-animation mb-4">
        <i class="bi bi-dice-6-fill"></i>
      </div>
      <h4 class="text-light fw-bold mb-2">Carregando...</h4>
      <p class="text-light opacity-75">Processando sua escolha</p>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      
      <!-- Header -->
      <div class="text-center mb-5">
        <h1 class="display-4 fw-bold mb-3 text-gradient">
          <i class="bi bi-dice-6"></i> Criar Personagem D&D
        </h1>
        <p class="lead text-muted">Crie seu aventureiro seguindo o Livro do Jogador ou suas próprias regras</p>
      </div>
      
      <!-- Progress Bar -->
      <div class="mb-4">
        <div class="progress" style="height: 30px;">
          <div class="progress-bar bg-success" 
               role="progressbar" 
               [style.width.%]="(step / totalSteps) * 100"
               [attr.aria-valuenow]="step" 
               aria-valuemin="0" 
               [attr.aria-valuemax]="totalSteps">
            Etapa {{step}} de {{totalSteps}}
          </div>
        </div>
      </div>

      <!-- Main Card -->
      <div class="card shadow-lg">
        <div class="card-body p-4">

          <!-- Step 1: Character Name -->
          <div *ngIf="step === 1">
            <h3 class="card-title mb-4">
              <i class="bi bi-person-circle"></i> Nome do Personagem
            </h3>
            <div class="mb-4">
              <label for="characterName" class="form-label">Qual é o nome do seu personagem?</label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="characterName"
                [(ngModel)]="character.name"
                placeholder="Digite o nome do personagem">
            </div>
            <!-- <div class="mb-3">
              <label for="fileUpload" class="form-label">Enviar arquivos</label>
              <input
                class="form-control"
                type="file"
                id="fileUpload"
                (change)="onFilesSelected($event)"
                multiple
              />
            </div> -->
          </div>

          <!-- Step 2: Ability Scores -->
          <div *ngIf="step === 2">
            <h3 class="card-title mb-4">
              <i class="bi bi-graph-up"></i> Atribua os Pontos de Atributo
            </h3>
            <p class="text-muted mb-3">
              Sistema de Pontos - Pontos restantes: 
              <span class="badge" [class.bg-success]="pointBuyPoints - calculateUsedPoints() === 0"
                    [class.bg-warning]="pointBuyPoints - calculateUsedPoints() > 0">
                {{pointBuyPoints - calculateUsedPoints()}}
              </span>
            </p>

            <div class="row g-3">
              <div class="col-md-6" *ngFor="let ability of getObjectKeys(character.attributes)">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h5 class="mb-0 text-uppercase">{{ability}}</h5>
                      <span class="badge bg-secondary">
                        Utilizados: {{getPointCost(character.attributes[ability])}}
                      </span>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between">
                      <button 
                        class="btn btn-outline-danger"
                        (click)="decreaseAbility(ability)"
                        [disabled]="!canDecreaseAbility(ability)">
                        <i class="bi bi-dash"></i>
                      </button>
                      
                      <div class="text-center mx-3">
                        <div class="h2 mb-0">{{character.attributes[ability]}}</div>
                        <small class="text-muted" *ngIf="getRaceBonus(ability) > 0">
                          +{{getRaceBonus(ability)}} racial
                        </small>
                        <div>
                          <span class="badge bg-info">
                            Modificador: {{getAbilityModifier(character.attributes[ability]) >= 0 ? '+' : ''}}{{getAbilityModifier(character.attributes[ability])}}
                          </span>
                        </div>
                      </div>
                      
                      <button 
                        class="btn btn-outline-success"
                        (click)="increaseAbility(ability)"
                        [disabled]="!canIncreaseAbility(ability)">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="alert alert-warning mt-4">
              <i class="bi bi-info-circle"></i> <strong>Atenção:</strong> Bônus raciais serão aplicados após esta etapa.
            </div>
          </div>

          <!-- Step 3: Race Selection -->
          <div *ngIf="step === 3">
            <h3 class="card-title mb-4">
              <i class="bi bi-people"></i> Escolha Sua Raça
            </h3>
            
            <div class="mb-4">
              <label class="form-label">Raça</label>
              <div *ngIf="races.length == 0" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando raças...</span>
                </div>
                <p class="mt-2 text-muted">Carregando raças...</p>
              </div>
              <div class="row g-3">
                <div class="col-md-4" *ngFor="let race of races">
                  <div class="card h-100" 
                       [class.border-primary]="character.race === race"
                       [class.bg-light]="character.race === race"
                       [class.disabled]="character.race != ''"
                       (click)="setRace(race)"
                       style="cursor: pointer;">
                    <div class="card-body text-center">
                      <h5 class="card-title">{{race}}</h5>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Background -->
          <div *ngIf="step === 4">
            <h3 class="card-title mb-4">
              <i class="bi bi-book"></i> Escolha o Antecedente
            </h3>
            <div class="row g-3">
              <div *ngIf="backgrounds.length == 0 || character.id == ''" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando antecedentes...</span>
                </div>
                <p class="mt-2 text-muted">Carregando antecedentes...</p>
              </div>
              <div class="col-md-4" *ngFor="let bg of backgrounds">
                <div class="card h-100" 
                     [class.border-primary]="character.background === bg"
                     [class.bg-light]="character.background === bg"
                     [class.disabled]="character.background != ''"
                     (click)="setBackground(bg)"
                     style="cursor: pointer;">
                  <div class="card-body text-center">
                    <h6 class="card-title">{{bg}}</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>

            <!-- <div class="mb-4" *ngIf="character.race">
              <label class="form-label">Sub-raça</label>
              <div *ngIf="subraces.length == 0" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando sub-raças...</span>
                </div>
                <p class="mt-2 text-muted">Carregando sub-raças...</p>
              </div>
              <div class="row g-3">
                <div class="col-md-4" *ngFor="let subrace of subraces">
                  <div class="card h-100" 
                       [class.border-primary]="selectedSubrace === subrace"
                       [class.bg-light]="selectedSubrace === subrace"
                       (click)="selectedSubrace = subrace"
                       style="cursor: pointer;">
                    <div class="card-body text-center">
                      <h6 class="card-title">{{subrace}}</h6>
                    </div>
                  </div>
                </div>
              </div>
            </div> -->

            <!-- <div class="alert alert-info" *ngIf="selectedSubrace">
              <strong>Bônus Raciais:</strong>
              <ul class="mb-0 mt-2">
                <li *ngFor="let attr of getAttributeKeys()">
                  <span *ngIf="getRaceBonus(attr) > 0">
                    {{attr}}: +{{getRaceBonus(attr)}}
                  </span>
                </li>
              </ul>
            </div>
          </div> -->

          <!-- Step 5: Class Selection -->
          <div *ngIf="step === 5">
            <h3 class="card-title mb-4">
              <i class="bi bi-shield"></i> Escolha Sua Classe
            </h3>
            <div class="row g-3">
              <div *ngIf="classes.length == 0" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando classes...</span>
                </div>
                <p class="mt-2 text-muted">Carregando classes...</p>
              </div>
              <div class="col-md-4" *ngFor="let className of classes">
                <div class="card h-100" 
                     [class.border-primary]="character.class === className"
                     [class.bg-light]="character.class === className"
                     (click)="selectClass(className)"
                     style="cursor: pointer;">
                  <div class="card-body text-center">
                    <h5 class="card-title">{{className}}</h5>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-4" *ngIf="character.class">
              <label class="form-label">Sub-classe</label>
              <div *ngIf="subclasses.length == 0" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando sub-classes...</span>
                </div>
                <p class="mt-2 text-muted">Carregando sub-classes...</p>
              </div>
              <div class="row g-3">
                <div class="col-md-4" *ngFor="let subclass of subclasses">
                  <div class="card h-100" 
                       [class.border-primary]="character.subclass === subclass"
                       [class.bg-light]="character.subclass === subclass"
                       (click)="character.subclass = subclass"
                       style="cursor: pointer;">
                    <div class="card-body text-center">
                      <h6 class="card-title">{{subclass}}</h6>
                    </div>
                  </div>
                </div>
              </div>
            </div>


          </div>

          <!-- Step 7: Alignment -->
          <div *ngIf="step === 7">
            <h3 class="card-title mb-4">
              <i class="bi bi-compass"></i> Escolha o Alinhamento
            </h3>
            <div class="row g-3">
              <div class="col-md-4" *ngFor="let align of alignments">
                <div class="card h-100" 
                     [class.border-primary]="character.alignment === align"
                     [class.bg-light]="character.alignment === align"
                     (click)="character.alignment = align"
                     style="cursor: pointer;">
                  <div class="card-body text-center">
                    <h6 class="card-title">{{align}}</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 8: Equipment & Features -->
          <div *ngIf="step === 8">
            <h3 class="card-title mb-4">
              <i class="bi bi-backpack"></i> Equipamentos & Características
            </h3>

            <div class="mb-4">
              <h5>Equipamentos Iniciais</h5>
              <ul class="list-group">
                <li class="list-group-item" *ngFor="let item of character.equipment">
                  {{item}}
                </li>
              </ul>
            </div>

            <div class="mb-4">
              <label class="form-label">Adicionar Equipamento Personalizado</label>
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  placeholder="Digite o nome do equipamento"
                  #customEquipment>
                <button 
                  class="btn btn-outline-primary" 
                  (click)="character.equipment.push(customEquipment.value); customEquipment.value = ''">
                  Adicionar
                </button>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label">Características & Traços (Opcional)</label>
              <div class="input-group mb-2">
                <input 
                  type="text" 
                  class="form-control" 
                  placeholder="Digite uma característica ou traço"
                  #customFeature>
                <button 
                  class="btn btn-outline-primary" 
                  (click)="character.features.push(customFeature.value); customFeature.value = ''">
                  Adicionar
                </button>
              </div>
              <ul class="list-group" *ngIf="character.features.length > 0">
                <li class="list-group-item" *ngFor="let feature of character.features; let i = index">
                  {{feature}}
                  <button class="btn btn-sm btn-outline-danger float-end" (click)="character.features.splice(i, 1)">
                    <i class="bi bi-trash"></i>
                  </button>
                </li>
              </ul>
            </div>
          </div>

          <!-- Step 9: Review & Finalize -->
          <div *ngIf="step === 9">
            <h3 class="card-title mb-4">
              <i class="bi bi-check-circle"></i> Review Your Character
            </h3>

            <div class="row mb-4">
                <div class="phb">
                    <div class="page">
                        <app-character-sheet
                        [character]="character"
                        [isWide]="true">
                        </app-character-sheet>
                    </div>
                </div>
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Basic Information</h5>
                  </div>
                  <div class="card-body">
                    <p><strong>Name:</strong> {{character.name}}</p>
                    <p><strong>Race:</strong> {{selectedSubrace}}</p>
                    <p><strong>Class:</strong> {{character.class}}</p>
                    <p><strong>Level:</strong> {{character.level}}</p>
                    <p><strong>Background:</strong> {{character.background}}</p>
                    <p class="mb-0"><strong>Alignment:</strong> {{character.alignment}}</p>
                  </div>
                </div>

                <div class="card mb-3">
                  <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Combat Stats</h5>
                  </div>
                  <div class="card-body">
                    <p><strong>Armor Class:</strong> {{character.armorClass}}</p>
                    <p><strong>Initiative:</strong> {{character.initiative >= 0 ? '+' : ''}}{{character.initiative}}</p>
                    <p><strong>Speed:</strong> {{character.speed}}</p>
                    <p><strong>Hit Points:</strong> {{character.hitPoints.max}}</p>
                    <p class="mb-0"><strong>Hit Dice:</strong> {{character.hitDice}}</p>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Ability Scores</h5>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-4 mb-3" *ngFor="let ability of getObjectKeys(character.attributes)">
                        <div class="border rounded p-2">
                          <div class="fw-bold">{{ability}}</div>
                          <div class="h4 mb-0">{{character.attributes[ability]}}</div>
                          <small class="text-muted">
                            ({{getAbilityModifier(character.attributes[ability]) >= 0 ? '+' : ''}}{{getAbilityModifier(character.attributes[ability])}})
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card mb-3">
                  <div class="card-header bg-warning">
                    <h5 class="mb-0">Skills</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- <div class="col-6" *ngFor="let skill of getSkillKeys()">
                        <div class="form-check" *ngIf="character.skills[skill]">
                          <input class="form-check-input" type="checkbox" checked disabled>
                          <label class="form-check-label">
                            {{skill}}
                          </label>
                        </div>
                      </div> -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Equipment</h5>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  <li *ngFor="let item of character.equipment">{{item}}</li>
                </ul>
              </div>
            </div>

            <div class="mb-4">
              <label for="notes" class="form-label">Character Notes (Optional)</label>
              <textarea 
                class="form-control" 
                id="notes"
                rows="4"
                [(ngModel)]="character.notes"
                placeholder="Add any additional notes about your character..."></textarea>
            </div>

            <div class="d-grid gap-2">
              <button class="btn btn-success btn-lg" (click)="downloadCharacter()">
                <i class="bi bi-download"></i> Download Character Sheet (JSON)
              </button>
              <button class="btn btn-outline-primary btn-lg" disabled>
                <i class="bi bi-printer"></i> Print Character Sheet (Coming Soon)
              </button>
            </div>
          </div>

          <!-- Decisões Dinâmicas -->
          <div *ngIf="decisionsArray.length > 0" class="mt-4">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              <strong>Decisões Necessárias:</strong> Complete as escolhas abaixo para continuar.
            </div>

            <div *ngFor="let decision of decisionsArray; let i = index" class="mb-4">
              <div class="card"
                  [class.border-success]="isDecisionComplete(i)"
                  [class.border-warning]="!isDecisionComplete(i) && i === currentDecisionIndex"
                  [class.opacity-50]="i > currentDecisionIndex">
                
                <div class="card-header d-flex justify-content-between align-items-center"
                    [class.bg-success]="isDecisionComplete(i)"
                    [class.bg-warning]="!isDecisionComplete(i) && i === currentDecisionIndex"
                    [class.text-white]="isDecisionComplete(i) || (!isDecisionComplete(i) && i === currentDecisionIndex)">
                  <div>
                    <i class="bi" 
                      [class.bi-check-circle-fill]="isDecisionComplete(i)"
                      [class.bi-circle]="!isDecisionComplete(i)"></i>
                    <strong class="ms-2">{{ decision.label }}</strong>
                  </div>
                  <span class="badge"
                        [class.bg-white]="isDecisionComplete(i) || (!isDecisionComplete(i) && i === currentDecisionIndex)"
                        [class.text-dark]="isDecisionComplete(i) || (!isDecisionComplete(i) && i === currentDecisionIndex)"
                        [class.bg-secondary]="!(isDecisionComplete(i) || (!isDecisionComplete(i) && i === currentDecisionIndex))">
                    {{ getSelectedCount(i) }}/{{ decision.n }}
                  </span>
                </div>

                <div class="card-body">
                  <!-- Loading -->
                  <div *ngIf="isLoadingDecision && i === currentDecisionIndex" 
                      class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Processando...</span>
                    </div>
                    <p class="mt-2 text-muted">Processando sua escolha...</p>
                  </div>

                  <!-- Opções -->
                  <div *ngIf="!isLoadingDecision || i !== currentDecisionIndex" 
                      class="row g-3">
                    <div class="col-md-6" *ngFor="let option of decision.options">
                      <button
                        type="button"
                        class="btn w-100 text-start p-3"
                        [class.btn-success]="isDecisionOptionSelected(i, option)"
                        [class.btn-outline-primary]="!isDecisionOptionSelected(i, option)"
                        [disabled]="isDecisionComplete(i) || i > currentDecisionIndex"
                        (click)="toggleDecisionOption(i, option)">
                        <i class="bi me-2"
                          [class.bi-check-circle-fill]="isDecisionOptionSelected(i, option)"
                          [class.bi-circle]="!isDecisionOptionSelected(i, option)"></i>
                        {{ option }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Resumo das Decisões Completas -->
            <div *ngIf="decisionsArray.length > 0" 
                class="alert alert-success">
              <h6><i class="bi bi-check-circle-fill"></i> Decisões Completas:</h6>
              <ul class="mb-0">
                <li *ngFor="let summary of getDecisionsSummary()">
                  {{ summary }}
                </li>
              </ul>
            </div>
          </div>

        </div>

        <!-- Navigation Footer -->
        <div class="card-footer bg-light">
          <div class="d-flex justify-content-between">
            <button 
              class="btn btn-secondary"
              (click)="prevStep()"
              [disabled]="step === 1">
              <i class="bi bi-chevron-left"></i> Voltar
            </button>

            <button 
              class="btn btn-outline-danger"
              (click)="resetCharacter()">
              <i class="bi bi-arrow-counterclockwise"></i> Recomeçar
            </button>

            <button 
              class="btn btn-primary"
              (click)="nextStep()"
              [disabled]="!canProceed()"
              *ngIf="step < totalSteps">
              Avançar <i class="bi bi-chevron-right"></i>
            </button>

            <span *ngIf="step === totalSteps" class="badge bg-success fs-5 d-flex align-items-center">
              <i class="bi bi-check-circle me-2"></i> Complete!
            </span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>